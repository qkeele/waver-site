<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reset Password – Waver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body style="background-color: black; color: white; font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0;">
  <h1 id="title">Resetting your password…</h1>

  <div id="form" style="display: none; flex-direction: column; align-items: center;">
    <input id="password1" type="password" placeholder="New Password" style="margin: 10px; padding: 10px;" oninput="validateCriteria()">
    <input id="password2" type="password" placeholder="Confirm New Password" style="margin: 10px; padding: 10px;">

    <ul style="list-style: none; padding: 0; margin-bottom: 10px; font-size: 0.9rem;">
      <li id="lengthCriteria">❌ At least 8 characters</li>
      <li id="complexityCriteria">❌ Includes letters, a number, and a symbol</li>
    </ul>

    <button id="submit" style="padding: 10px 20px; background-color: #0284c7; color: white;">Update Password</button>
    <p id="error" style="color: #f87171;"></p>
    <p id="status" style="color: #34d399;"></p>
  </div>

  <script>
    // Initialize the Supabase client
    const supabase = window.supabase.createClient(
      'https://YOUR_SUPABASE_URL.supabase.co',
      'YOUR_ANON_PUBLIC_API_KEY'
    );

    // 1) Grab query params
    const query = new URLSearchParams(window.location.search);
    const code = query.get("code");   // This is the reset token
    const email = query.get("email")?.toLowerCase();

    // 2) DOM elements
    const title = document.getElementById("title");
    const form = document.getElementById("form");
    const errorEl = document.getElementById("error");
    const statusEl = document.getElementById("status");

    function passwordHasSymbolAndNumber(password) {
      const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$&*._-]).+$/;
      return regex.test(password);
    }

    function validateCriteria() {
      const password = document.getElementById("password1").value;
      const lengthEl = document.getElementById("lengthCriteria");
      const complexityEl = document.getElementById("complexityCriteria");

      if (password.length >= 8) {
        lengthEl.textContent = "✅ At least 8 characters";
        lengthEl.style.color = "#34d399";
      } else {
        lengthEl.textContent = "❌ At least 8 characters";
        lengthEl.style.color = "#f87171";
      }

      if (passwordHasSymbolAndNumber(password)) {
        complexityEl.textContent = "✅ Includes letters, a number, and a symbol";
        complexityEl.style.color = "#34d399";
      } else {
        complexityEl.textContent = "❌ Includes letters, a number, and a symbol";
        complexityEl.style.color = "#f87171";
      }
    }

    async function start() {
      console.log("Starting password reset flow...");
      console.log("Parsed URL:", { code, email });

      // If the code is missing, we can't do a recovery
      if (!code) {
        title.textContent = "Missing code in the URL.";
        console.error("Missing code parameter");
        return;
      }

      try {
        // 3) Verify OTP with supabase.auth.verifyOtp
        console.log("Calling verifyOtp with:", {
          type: 'recovery',
          token: code,
          email: email
        });

        const { data, error } = await supabase.auth.verifyOtp({
          type: 'recovery',
          token: code,
          email: email
        });

        if (error || !data?.session) {
          console.error("verifyOtp error:", error);
          title.textContent = "Could not restore session. The link may be invalid or expired.";
          return;
        }

        console.log("Session restored:", data.session);
        title.textContent = "Enter your new password below";
        form.style.display = "flex";

        // 4) On submit, update the user's password
        document.getElementById("submit").onclick = async () => {
          const p1 = document.getElementById("password1").value;
          const p2 = document.getElementById("password2").value;
          errorEl.textContent = "";
          statusEl.textContent = "";

          if (!p1 || !p2) {
            errorEl.textContent = "Both fields are required.";
            return;
          }

          if (p1 !== p2) {
            errorEl.textContent = "Passwords don't match.";
            return;
          }

          if (p1.length < 8 || !passwordHasSymbolAndNumber(p1)) {
            errorEl.textContent = "Password must meet all criteria.";
            return;
          }

          console.log("Calling updateUser with new password");
          const { error: updateError } = await supabase.auth.updateUser({ password: p1 });

          if (updateError) {
            console.error("Password update error:", updateError);
            errorEl.textContent = updateError.message;
          } else {
            form.style.display = "none";
            title.textContent = "Password updated successfully!";
            statusEl.textContent = "You can now log in.";
            console.log("Password updated successfully.");
          }
        };
      } catch (err) {
        console.error("Unexpected error in reset flow:", err);
        title.textContent = "An unexpected error occurred.";
      }
    }

    start();
  </script>
</body>
</html>