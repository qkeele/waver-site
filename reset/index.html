<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Reset Password</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
<h2 id="status">Checking link...</h2>
<div id="form" style="display:none;">
  <p>New Password:</p>
  <input id="p1" type="password">
  <p>Confirm Password:</p>
  <input id="p2" type="password">
  <button id="updateBtn">Update Password</button>
</div>
<p id="message" style="color:red;"></p>

<script>
  // 1) Supabase init
  const supabase = window.supabase.createClient(
    "https://YOUR-PROJECT.supabase.co",
    "YOUR_ANON_PUBLIC_KEY"
  );

  // 2) Parse ?code=... and ?email=...
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const email = params.get("email"); // <— Must exist if you’re using email-based auth

  const statusEl = document.getElementById("status");
  const formEl = document.getElementById("form");
  const msgEl = document.getElementById("message");
  const updateBtn = document.getElementById("updateBtn");

  if (!code || !email) {
    statusEl.textContent = "Link is missing 'code' or 'email'.";
  } else {
    verifyCode();
  }

  async function verifyCode() {
    try {
      // 3) Pass code + email to verify
      const { data, error } = await supabase.auth.verifyOtp({
        type: "recovery",
        token: code,
        email: email
      });

      if (error || !data?.session) {
        console.error("verifyOtp error:", error);
        statusEl.textContent = "Link invalid or expired.";
      } else {
        statusEl.textContent = "Enter a new password:";
        formEl.style.display = "block";

        // 4) Handle password update
        updateBtn.onclick = async () => {
          msgEl.textContent = "";
          const p1 = document.getElementById("p1").value;
          const p2 = document.getElementById("p2").value;
          if (!p1 || !p2 || p1 !== p2) {
            msgEl.textContent = "Please make sure both passwords match.";
            return;
          }

          const { error: updateError } = await supabase.auth.updateUser({ password: p1 });
          if (updateError) {
            console.error(updateError);
            msgEl.textContent = updateError.message;
          } else {
            formEl.style.display = "none";
            statusEl.textContent = "Password updated successfully!";
          }
        };
      }
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Something went wrong verifying the code.";
    }
  }
</script>
</body>
</html>