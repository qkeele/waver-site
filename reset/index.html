<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Reset Password</title>
  <!-- 1) Load supabase-js library first -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body style="font-family:sans-serif; margin:20px;">
<h2 id="status">Checking your reset link...</h2>

<div id="form" style="display:none;">
  <p>New Password:</p>
  <input type="password" id="p1" style="margin-bottom:10px;">
  <p>Confirm Password:</p>
  <input type="password" id="p2" style="margin-bottom:10px;">
  <br/>
  <button id="updateBtn">Update Password</button>
</div>

<p id="message" style="color:red;"></p>

<script>
  // 2) REAL Supabase project details
  //    (from your earlier code, you said these are correct)
  const supabase = window.supabase.createClient(
    "https://vfpcqlulhiwqjnwfxjof.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmcGNxbHVsaGl3cWpud2Z4am9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk0NDEzNjMsImV4cCI6MjA1NTAxNzM2M30.wvRniBlP_Ucn_rQ0fEid_YiT4VHf106zFbBu3wCIg-o"
  );

  // 3) Parse URL params (we expect ?code=... &email=...)
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const email = params.get("email");

  const statusEl = document.getElementById("status");
  const formEl = document.getElementById("form");
  const msgEl = document.getElementById("message");
  const updateBtn = document.getElementById("updateBtn");

  // If code or email missing, can't verify
  if (!code || !email) {
    statusEl.textContent = "Missing code or email in the link.";
  } else {
    verifyCode();
  }

  async function verifyCode() {
    try {
      // 4) Attempt to verify the OTP (type: 'recovery')
      const { data, error } = await supabase.auth.verifyOtp({
        type: "recovery",
        token: code,
        email: email
      });

      // If there's an error or no session, token is invalid/expired
      if (error || !data?.session) {
        console.error("verifyOtp error:", error);
        statusEl.textContent = "Link invalid or expired.";
      } else {
        // If success, show form for new password
        statusEl.textContent = "Enter a new password:";
        formEl.style.display = "block";

        updateBtn.onclick = async () => {
          msgEl.textContent = "";
          const p1 = document.getElementById("p1").value;
          const p2 = document.getElementById("p2").value;

          if (!p1 || !p2) {
            msgEl.textContent = "Both fields required.";
            return;
          }
          if (p1 !== p2) {
            msgEl.textContent = "Passwords don't match.";
            return;
          }

          // 5) Update password
          const { error: updateError } = await supabase.auth.updateUser({
            password: p1
          });

          if (updateError) {
            console.error("updateUser error:", updateError);
            msgEl.textContent = updateError.message;
          } else {
            formEl.style.display = "none";
            statusEl.textContent = "Password updated successfully!";
          }
        };
      }
    } catch (err) {
      console.error("Exception verifying code:", err);
      statusEl.textContent = "Something went wrong verifying the code.";
    }
  }
</script>
</body>
</html>